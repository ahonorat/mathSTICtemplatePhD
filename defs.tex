%%%%%%%%%%%%%%%%%
%%% main packages
%%%%%%%%%%%%%%%%%

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[euler]{textgreek}
\usepackage{lmodern}

\usepackage[french,english]{babel} %% last language is default (english here)

\usepackage{setspace} %% to increase spacing between lines
\usepackage{emptypage} %% to disable numbering on blank pages
\usepackage{xcolor} %% for the colors
\usepackage{geometry} %% for the margins
\usepackage{multicol} %% for the back matter
\usepackage{eso-pic} %% for the bacground pictures in front and back matters
%% \usepackahe{caption} %% highly recommended
%% \usepackage{subcaption} %% to have subfigures
\usepackage{minitoc} %% to have local toc in chapters, etoc package is also good, but a bit more complicated
\usepackage{tikz} %% for the placement of figures in front and back matters 
\usetikzlibrary{babel} %% here load more tikz libs if needed, babel is a compatibility lib for the babel package
\usepackage{tabularx} %% to have autoline break in front cover
\usepackage{xparse} %% to store jury members
\usepackage{forloop} %% to iterate over jury members


%% We strongly recommend to use biblatex and biber for the bibliography
\usepackage[backend=biber,style=alphabetic,doi=false,isbn=false,hyperref=true,backref=true,maxbibnames=99,giveninits=true]{biblatex}
\usepackage{tocbibind}


%% to have pdf with clickable links
\usepackage[pdfusetitle,colorlinks=true]{hyperref}
%% to automatically prefix refs by the right label (figure, algorithm, etc.), must be called after hyperref, so at the end
%% to use it: \Cref{lbl:alabel}
\usepackage{cleveref}


%%%%%%%%%%%%%%%%%%%%%
%%% template MathSTIC
%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%% TITRE THESE PAGE DE GARDE %%%%%%%%%%%%%%%%

\makeatletter

% Logo ecole doctorale
\newcommand{\logoecoledoc}[1]{\gdef\@logoecoledoc{#1}}
\logoecoledoc{}

% Logo etablissement delivrant le diplome
\newcommand*{\logoetablissement}[1]{\gdef\@logoetablissement{#1}}
\logoetablissement{}

%%%% Titre en fran{\c c}ais
\newcommand{\setTitleFR}[1]{\gdef\@titleFR{#1}}
\setTitleFR{}
\newcommand{\getTitleFR}{\@titleFR}

%%%% Titre en anglais
\newcommand{\setTitleEN}[1]{\gdef\@titleEN{#1}}
\setTitleEN{}
\newcommand{\getTitleEN}{\@titleEN}

%%%% Eventuel sous-titre
\newcommand{\asubtitle}[1]{\gdef\@asubtitle{#1}}
\asubtitle{}

%%%% Discipline
\newcommand{\discipline}[1]{\gdef\@discipline{#1}}
\discipline{}

%%%% etablissement
\newcommand{\etablissement}[1]{\gdef\@etablissement{#1}}
\etablissement{}

%%%%% Ecole doctorale
\newcommand{\nbecoledoc}[1]{\gdef\@nbecoledoc{#1}}
\nbecoledoc{}

%%%%% Nom ecole
\newcommand{\nomecoledoc}[1]{\gdef\@nomecoledoc{#1}}
\nomecoledoc{}

%%%%% Sp\'{e}cialit\'{e}
\newcommand{\specialite}[1]{\gdef\@specialite{#1}}
\specialite{}

%%% Ville de soutenance
\newcommand{\lieu}[1]{\gdef\@lieu{#1}}
\lieu{}

%%% Unite de recherche
\newcommand{\uniterecherche}[1]{\gdef\@uniterecherche{#1}}
\uniterecherche{}

%%% Num{\'e}ro de la th{\`e}se
\newcommand{\numthese}[1]{\gdef\@numthese{#1}}
\numthese{}


%%% date
\newcommand{\datesoutenance}[1]{\gdef\@datesoutenance{#1}}
\datesoutenance{}

%%% lieu
\newcommand{\lieusoutenance}[1]{\gdef\@lieusoutenance{#1}}
\lieusoutenance{}

%%%%%%%%%% FONT SIZES


% Define commands to set fonts throughout the document
\newcommand*{\selectfontfrontcover}{\fontfamily{phv}\selectfont}  % Font style used in front cover 
\newcommand*{\selectfontbackcover}{\fontfamily{phv}\selectfont}   % Font style used in back cover 
\newcommand*{\selectfontchapheads}{\fontfamily{phv}\selectfont} % Font style used chapter headings


%%%%%%%%%%%%%%%% COULEURS RGB de l'ED%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definecolor{grisfonce}{RGB}{49,49,49}
\definecolor{grisclair}{RGB}{111,111,111}
\definecolor{blanc}{RGB}{255,255,255}
\definecolor{mathSTIC-Color}{RGB}{233,90,104}


%%%%%%%%%%%%% LOGOS EN-TETES %%%%%%%%%%%%


\newcommand{\coverheader}[1]{%
\AddToShipoutPicture*{%
    \put(0,0){%
    \parbox[b][\paperheight]{\paperwidth}{%
        \includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio]{#1}%
        \vfill
}}}
\thispagestyle{empty}
\clearpage
\begin{tikzpicture}[remember picture,overlay]

  %% check if path to logo has been set, adapted from
  %% https://tex.stackexchange.com/questions/53068/how-to-check-if-a-macro-value-is-empty-or-will-not-create-text-with-plain-tex-co
  {\if\relax\@logoecoledoc\relax
      %% if empty, do nothing
  \else
      %% if not empty, include logo
      \node[anchor=north west, yshift=-1.5cm, xshift=1.5cm] at (current page.north west) {
          \includegraphics[width=5cm,height=2.5cm,keepaspectratio]{\@logoecoledoc}
      };
  \fi
  }
  
  {\if\relax\@logoetablissement\relax
      %% if empty, do nothing
  \else
      %% if not empty, include logo
      \node[anchor=north east, yshift=-1.5cm, xshift=-1.5cm] at (current page.north east){
          \includegraphics[width=5cm,height=2.5cm,keepaspectratio]{\@logoetablissement}
      };
  \fi
  }

\end{tikzpicture}
\par\nobreak
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%% PREMIERE DE COUVERTURE %%%%%%

% Define some font sizes specific to the front cover
\newcommand{\HugeFront}{\fontsize{26}{31}\selectfont} % Used in 'these de doctorat' title
\newcommand{\LargeFront}{\fontsize{16}{19}\selectfont} % Used in thesis title
\newcommand{\JuryFontSize}{\fontsize{9.5}{11}\selectfont} % Used in tables for jury
%% LARGE, large, small of 12pt: 20.74pt, 14.4pt, 10.95pt
\newcommand{\LARGEtwelve}{\fontsize{20.74}{25}\selectfont} % original 12pt \LARGE
\newcommand{\largetwelve}{\fontsize{14.4}{17}\selectfont} % original 12pt \large
\newcommand{\normaltwelve}{\fontsize{12}{13.2}\selectfont} % original 12pt \normalsize
\newcommand{\smalltwelve}{\fontsize{11}{12.5}\selectfont} % original 12pt \small


%% Data structure to store jury members
%% https://tex.stackexchange.com/questions/215563/storing-an-array-of-strings-in-a-command
\ExplSyntaxOn
\NewDocumentCommand{\storedata}{mm}
  {
   \bcp_store_data:nn { #1 } { #2 }
  }

\NewDocumentCommand{\appenddata}{mm}
 {
  \bcp_append_data:nn { #1 } { #2 }
 }

\NewExpandableDocumentCommand{\getdata}{O{1}m}
 {
  \bcp_get_data:nn { #1 } { #2 }
 }

\NewExpandableDocumentCommand{\getlength}{m}
 {
  \seq_count:c { l_bcp_data_#1_seq }
 }


\cs_new_protected:Npn \bcp_store_data:nn #1 #2
 {
  % create the sequence if it doesn't exist or clear it if it exists
  \seq_clear_new:c { l_bcp_data_#1_seq }
  % append the items
  \__bcp_append_data:nn { #1 } { #2 }
 }

\cs_new_protected:Npn \bcp_append_data:nn #1 #2
 {
  % create the sequence if it doesn't exist, do nothing if it exists
  \seq_if_exist:cF { l_bcp_data_#1_seq }
   { \seq_new:c { l_bcp_data_#1_seq } }
  % append the items
  \__bcp_append_data:nn { #1 } { #2 }
 }

\cs_new_protected:Npn \__bcp_append_data:nn #1 #2
 {
  % append items one at a time
  \tl_map_inline:nn { #2 }
   {
    \seq_put_right:cn { l_bcp_data_#1_seq } { ##1 }
   }
 }

\cs_new:Npn \bcp_get_data:nn #1 #2
 {
  % retrieve the requested item
  \seq_item:cn { l_bcp_data_#2_seq } { #1 }
 }


\ExplSyntaxOff

%% https://stackoverflow.com/questions/49393784/how-can-i-sum-two-numbers-in-latex-with-my-own-command
%% https://tex.stackexchange.com/questions/258042/accessing-value-in-forloop
\newcounter{JuryIterator}
\newcounter{JuryLimit}

%% inspired from:
%% https://tex.stackexchange.com/questions/360031/trying-to-create-dynamic-table-and-commands-alltogether
\newcommand{\AddReviewer}[2]{
\appenddata{reviewers}{{#1&#2}}
}
\newcommand{\MakeReviewerTable}{
\setcounter{JuryLimit}{\getlength{reviewers}}
\stepcounter{JuryLimit}
{\normaltwelve \textbf{Rapporteurs avant soutenance :}\par}
{\JuryFontSize 
\vspace{0.25cm}
\begin{tabularx}{\textwidth}{@{}p{0.3\textwidth}X}
\forloop{JuryIterator}{1}{\value{JuryIterator} < \value{JuryLimit}}{
\getdata[\arabic{JuryIterator}]{reviewers}\\
}
\end{tabularx} \par
}}

\newcommand{\AddRegularJuryMember}[3]{
\appenddata{members}{{#1&#2&#3}}
}
\newcommand{\MakeJuryMemberTable}{
\setcounter{JuryLimit}{\getlength{members}}
\stepcounter{JuryLimit}
{\normaltwelve \textbf{Composition du Jury :}\par}
{\JuryFontSize 
\vspace{0.25cm}
\begin{tabularx}{\textwidth}{@{}p{0.15\textwidth}p{0.3\textwidth}X}
\forloop{JuryIterator}{1}{\value{JuryIterator} < \value{JuryLimit}}{
\getdata[\arabic{JuryIterator}]{members}\\
}
\end{tabularx} \par
}
}

\newcommand{\AddInvitedJuryMember}[2]{
\appenddata{invited}{{#1&#2}}
}
\newcommand{\MakeJuryInvitedTable}{
\setcounter{JuryLimit}{\getlength{invited}}
\stepcounter{JuryLimit}
\ifnum\value{JuryLimit}>1
{\normaltwelve \textbf{Invit{\'e}(s) :}\par}
{\JuryFontSize 
\vspace{0.25cm}
\begin{tabularx}{\textwidth}{@{}p{0.3\textwidth}X}
\forloop{JuryIterator}{1}{\value{JuryIterator} < \value{JuryLimit}}{
\getdata[\arabic{JuryIterator}]{invited}\\
}
\end{tabularx} \par
}
\fi
}



%% remove indentation, adapted from
%% https://tex.stackexchange.com/questions/59245/how-to-disable-automatic-indent
\newlength\tindent
\setlength{\tindent}{\parindent}

%mise en page de la page de garde

\def\maketitle{%
\setlength{\parindent}{0pt}%
{\normaltwelve \selectfontfrontcover% Set font style for front cover page
% however we need sapcing env since we dont want that user settings modify the cover
\begin{spacing}{1}
        \vspace{3cm}
        {\HugeFront \textsc{Th{\`e}se de doctorat de} \par}
        \vspace{2.2cm}
        {\largetwelve \textsc{\@etablissement} \par}
        \vspace{0.5cm}
        {\smalltwelve \textsc{{\'E}cole Doctorale \No \@nbecoledoc} \par}
        {\normaltwelve \textit{\@nomecoledoc} \par}
        {\normaltwelve Sp{\'e}cialit{\'e} : \textit{\@specialite} \par}
        \vspace{0.5cm}
        \hspace{0.6cm}{\normaltwelve Par \par}
        \vspace{0.25cm}
        \hspace{0.6cm}{\LARGEtwelve \textbf{\@author} \par}
        \vspace{0.6cm}
        {\LargeFront \textbf{\@title} \par}
        \vspace{0.4cm}
        {\largetwelve \@asubtitle \par}
        \vspace{0.8cm}
        {\smalltwelve \textbf{Th{\`e}se pr{\'e}sent{\'e}e et soutenue {\`a} \@lieusoutenance, le \@datesoutenance} \par}
	{\smalltwelve \textbf{Unit{\'e} de recherche : \@uniterecherche} \par}
	{\smalltwelve \textbf{Th{\`e}se \No : \@numthese} \par}
        \vspace{1cm}
        \MakeReviewerTable
        \MakeJuryMemberTable
        \MakeJuryInvitedTable
\end{spacing}
}
\setlength{\parindent}{\tindent}
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%% QUATRIEME DE COUVERTURE %%%%%%%%%%%%%%%%

\newcommand{\abstractFR}[2]{%
\selectlanguage{french}
\selectfontbackcover\smalltwelve
\vspace{3.3cm}
{\centering \noindent \textcolor{mathSTIC-Color}{\rule{\textwidth}{0.2cm}}\par}
\vspace{0.3cm}
{\noindent \textcolor{mathSTIC-Color}{\textbf{Titre~:}}~{\normaltwelve\getTitleEN{}} \par}
\vspace{0.3cm}
{\noindent \textbf{Mots-cl{\'e}s~:}~#1\par}
\vspace{-0.2cm}
\begin{multicols}{2}
\begin{spacing}{1}
{\smalltwelve
\noindent \textbf{R{\'e}sum{\'e}~:}~#2\par}
\end{spacing}
\end{multicols}
}

\newcommand{\abstractEN}[2]{%
\selectlanguage{english}
\selectfontbackcover\smalltwelve
\vspace{0.5cm}
{\centering \noindent \textcolor{mathSTIC-Color}{\rule{\textwidth}{0.2cm}}\par}
\vspace{0.3cm}
{\noindent \textcolor{mathSTIC-Color}{\textbf{Title:}}~{\normaltwelve\getTitleEN{}} \par}
\vspace{0.3cm}
{\noindent \textbf{Keywords:}~#1\par}
\vspace{-0.2cm}
\begin{multicols}{2}
\begin{spacing}{1}
{\smalltwelve
\noindent \textbf{Abstract:}~#2\par}
\end{spacing}
\end{multicols}
}


\makeatother



%%%%%%%%%%%%%%%%%%%%%%%
%%% other redefinitions
%%%%%%%%%%%%%%%%%%%%%%%


\newcommand*\cleartoleftpage{%
  \clearpage
  \ifodd\value{page}\hbox{}\pagestyle{empty}\newpage\fi
}
